<html>
<body>
	<canvas id='myCanvas' width='1024' height='2048' style='position:absolute; left:0; top:0'></canvas>
	<!-- <label id='result' style='position:absolute; left:0; top:550'>Click on the image at the bottom to select a tile, then click on the grid to draw.</label> -->
	<script>
		let image = new Image();
		image.src = 'Source/Artwork/level_tiles-table-48-48.png';
		
		const mapRows = 256/16;
		const mapColumns = 256/16;
		
		const sourceWidth = 240;
		const sourceHeight = 240;
		
		const sourceTileWidth = 48;
		const sourceTileHeight = 48;

		const tileWidth = 16;
		const tileHeight = 8;

		let tiles = new Array(mapColumns * mapRows);
		let mapHeight = mapRows * tileHeight;
		let mapWidth = mapColumns * tileWidth;
		let sourceX, sourceY, sourceTile;
		
		let canvas = document.getElementById('myCanvas');
		let context = canvas.getContext('2d');

		canvas.addEventListener('click', doMouseClick);
		canvas.addEventListener('mousemove', doMouseMove);
		image.addEventListener('load', redrawSource);

		// draw the grid
		for (let i = 0; i <= mapColumns; i++) {
			context.moveTo(i * tileWidth, 0);
			context.lineTo(i * tileWidth, mapHeight);
		}
		context.stroke();
		
		for (let i = 0; i <= mapRows; i++) {
			context.moveTo(0, i * tileHeight);
			context.lineTo(mapWidth, i * tileHeight);
		}
		context.stroke();

		function redrawSource() {
			context.drawImage(image, 0, 0, sourceWidth, sourceHeight, mapWidth+10, 0, sourceWidth, sourceHeight);
		}

		function doMouseClick(e) {
			let x = e.clientX;
			let y = e.clientY;

			// source
			let gridX = Math.floor(x / sourceTileWidth) * sourceTileWidth;
			let gridY = Math.floor(y / sourceTileHeight) * sourceTileHeight;
			if (y > mapHeight && y < (mapHeight + sourceHeight) && x < sourceWidth) {
				let tileX = Math.floor(x / sourceTileWidth);
				let tileY = Math.floor((y - mapHeight) / sourceTileHeight);
				sourceTile = tileY * (sourceWidth / sourceTileWidth) + tileX;
				sourceX = gridX;
				sourceY = gridY - mapHeight;
				redrawSource();
				drawSourceBox();
			}

			// target
			gridX = Math.floor(x / tileWidth) * tileWidth;
			gridY = Math.floor(y / tileHeight) * tileHeight;
			if (y < mapHeight && x < mapWidth) {
				context.clearRect(gridX, gridY, tileWidth, tileHeight);
				context.drawImage(image, sourceX, sourceY, tileWidth, tileHeight, gridX, gridY, tileWidth, tileHeight);
				let tileX = Math.floor(x / tileWidth);
				let tileY = Math.floor(y / tileHeight);
				let targetTile = tileY * mapColumns + tileX;
				tiles[targetTile] = sourceTile;
				// update the string    
				let string = 'let tiles = [';
				for (let i = 0; i < mapColumns * mapRows; i++) {
					if (tiles[i] != undefined) string = string + tiles[i];
					string = string + ',';
				}
				string = string + '];';
				document.getElementById('result').innerHTML = string;
			}
		}

		function doMouseMove(e) {
			let x = e.clientX;
			let y = e.clientY;
			// source
			if (y > mapHeight && y < (mapHeight + sourceHeight) && x < sourceWidth) {
				let gridX = Math.floor(x / sourceTileWidth) * sourceTileWidth;
				let gridY = Math.floor(y / sourceTileHeight) * sourceTileHeight;
				context.clearRect(0, mapHeight, sourceWidth, sourceHeight);
				redrawSource();
				context.beginPath();
				context.strokeStyle = 'blue';
				context.rect(gridX, gridY, sourceTileWidth, sourceTileHeight);
				context.stroke();
				drawSourceBox();
			}
		}

		function drawSourceBox() {
			context.beginPath();
			context.strokeStyle = 'red';
			context.rect(sourceX, sourceY + mapHeight, sourceTileWidth, sourceTileHeight);
			context.stroke();
		}

		function drawBox() {
			context.beginPath();
			context.strokeStyle = 'red';
			context.rect(sourceX, sourceY + mapHeight, tileWidth, tileHeight);
			context.stroke();
		}
	</script>
</body>
</html>